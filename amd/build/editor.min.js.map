{"version":3,"file":"editor.min.js","sources":["../src/editor.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module mod_onlyofficeeditor/editor\n * @copyright  2024 Ascensio System SIA <integration@onlyoffice.com>\n * @copyright  based on work by 2018 Olumuyiwa Taiwo <muyi.taiwo@logicexpertise.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n **/\ndefine(['jquery'], function($) {\n    var displayNotification = function(error, type) {\n        require(['core/notification'], function(notification) {\n            require(['core/str'], function(str) {\n                var errorIsAvailable = str.get_string(error, 'onlyofficeeditor');\n                $.when(errorIsAvailable).done(function(localizedStr) {\n                    notification.addNotification({\n                        message: localizedStr,\n                        type: type\n                    });\n                });\n            });\n        });\n    };\n\n    var createFullScreenButtons = function() {\n        require(['core/str'], function(str) {\n            var enterFullScreenText = str.get_string('editorenterfullscreen', 'onlyofficeeditor');\n            var exitFullScreenText = str.get_string('editorexitfullscreen', 'onlyofficeeditor');\n            var navLeftButton = $('.drawertoggle')[1];\n            var navRightButton = $('.drawertoggle')[2];\n            var editorContainer = $('.onlyofficeeditor-container')[0];\n\n            $.when(enterFullScreenText).done(function(localized) {\n                enterFullScreenText = localized;\n                var enterButton = document.createElement('button');\n                var enterIcon = document.createElement('i');\n                enterIcon.className = 'icon fa fa-expand fa-fw';\n                enterButton.appendChild(enterIcon);\n                enterButton.className = 'onlyofficeeditor-editor-fs-button';\n                enterButton.id = 'onlyofficeeditor-enter-fs-button';\n                enterButton.innerHTML += enterFullScreenText;\n\n                enterButton.onclick = function() {\n                    $('header').hide();\n                    $('footer').hide();\n                    if (navLeftButton && navLeftButton.getAttribute('data-aria-hidden-tab-index') === null) {\n                        $(navLeftButton).click();\n                    }\n                    if (navRightButton && navRightButton.getAttribute('data-aria-hidden-tab-index') === null) {\n                        $(navRightButton).click();\n                    }\n                    if ($('.editmode-switch-form').length > 0 && $('.editmode-switch-form')[0][0].checked) {\n                        $(editorContainer).addClass('onlyofficeeditor-rightindent');\n                    }\n                    $(editorContainer).addClass('onlyofficeeditor-fullscreen');\n                    editorContainer.children[0].style.height = '93vh';\n                    $('#onlyofficeeditor-enter-fs-button').hide();\n                    $('#onlyofficeeditor-exit-fs-button').show();\n                };\n                editorContainer.before(enterButton);\n            });\n            $.when(exitFullScreenText).done(function(localized) {\n                exitFullScreenText = localized;\n                var exitButton = document.createElement('button');\n                var exitIcon = document.createElement('i');\n                exitIcon.className = 'icon fa fa-compress fa-fw';\n                exitButton.appendChild(exitIcon);\n                exitButton.innerHTML += exitFullScreenText;\n                exitButton.className = 'onlyofficeeditor-editor-fs-button';\n                exitButton.id = 'onlyofficeeditor-exit-fs-button';\n\n                exitButton.onclick = function() {\n                    $(editorContainer).removeClass('onlyofficeeditor-fullscreen');\n                    $(editorContainer).removeClass('onlyofficeeditor-rightindent');\n                    editorContainer.children[0].style.height = '95vh';\n                    $('header').show();\n                    $('footer').show();\n                    $('#onlyofficeeditor-enter-fs-button').show();\n                    $('#onlyofficeeditor-exit-fs-button').hide();\n                };\n                $('#usernavigation')[0].prepend(exitButton);\n                $('#onlyofficeeditor-exit-fs-button').hide();\n            });\n        });\n    };\n\n    $.urlParam = function(name) {\n        var results = new RegExp('[\\\\?&]' + name + '=([^&#]*)').exec(window.location.href);\n        if (results === null) {\n            return null;\n        }\n        return decodeURI(results[1]) || 0;\n    };\n\n    var replaceActionLink = function(href, linkParam) {\n        var link;\n        var actionIndex = href.indexOf(\"&actionType=\");\n        if (actionIndex != -1) {\n            link = href.substring(0, actionIndex) + \"&actionType=\" + encodeURIComponent(linkParam.type) +\n                \"&actionData=\" + encodeURIComponent(linkParam.data);\n        } else {\n            link = href + \"&actionType=\" + encodeURIComponent(linkParam.type) + \"&actionData=\" + encodeURIComponent(linkParam.data);\n        }\n        return link;\n    };\n\n    var displaySaveAsModal = function(saveAsData, cmid, courseid) {\n        require(['mod_onlyofficeeditor/modal_saveas'],\n            function(ModalSaveas) {\n                ModalSaveas.build(cmid, courseid, saveAsData);\n            });\n    };\n\n    return {\n        init: function(courseid, cmid) {\n            if (typeof DocsAPI === \"undefined\") {\n                displayNotification('docserverunreachable', 'error');\n                return;\n            }\n            createFullScreenButtons();\n            var ajaxUrl = M.cfg.wwwroot + '/mod/onlyofficeeditor/dsconfig.php';\n            $.getJSON(ajaxUrl, {\n                courseid: courseid,\n                cmid: cmid,\n                actionType: $.urlParam('actionType'),\n                actionData: $.urlParam('actionData')\n            }).done(function(data) {\n                var docEditor = null;\n                var config = data.config;\n\n                document.head.innerHTML += '<link type=\"image/x-icon\" rel=\"icon\" href=\"/mod/onlyofficeeditor/pix/'\n                    + config.documentType + '.ico\" />';\n\n                var canAddInstance = data.addinstance;\n\n                const innerAlert = (message, inEditor) => {\n                    // eslint-disable-next-line no-console\n                    if (console && console.log) {\n                        // eslint-disable-next-line no-console\n                        console.log(message);\n                    }\n                    if (inEditor && docEditor) {\n                        docEditor.showMessage(message);\n                    }\n                };\n\n                var onMakeActionLink = function(event) {\n                    var actionData = event.data.action;\n                    docEditor.setActionLink(replaceActionLink(location.href, actionData));\n                };\n\n                var onRequestSendNotify = function(event) {\n                    var comment = event.data.message;\n                    var emails = event.data.emails;\n                    var replacedActionLink = replaceActionLink(location.href, event.data.actionLink.action);\n\n                    var mentionData = {\n                        comment: comment,\n                        emails: emails,\n                        link: replacedActionLink,\n                        courseid: courseid\n                    };\n\n                    $.ajax(M.cfg.wwwroot + '/mod/onlyofficeeditor/onlyofficeeditorapi.php?apiType=mention&cmid=' + cmid, {\n                        type: 'POST',\n                        dataType: 'json',\n                        data: mentionData\n                    }).fail(() => {\n                        displayNotification('onmentionerror', 'error');\n                    });\n                };\n\n                const onAppReady = () => {\n                    innerAlert(\"Document editor ready\");\n                };\n\n                const onError = (event) => {\n                    if (event) {\n                        innerAlert(event.data);\n                    }\n                };\n                config.events = {\n                    'onAppReady': onAppReady,\n                    'onError': onError,\n                    'onMakeActionLink': onMakeActionLink\n                };\n\n                var onRequestSaveAs = function(event) {\n                    var saveAsData = {\n                        title: event.data.title,\n                        url: event.data.url,\n                        courseid: courseid,\n                        section: null\n                    };\n                    displaySaveAsModal(saveAsData, cmid, courseid);\n                };\n\n                if (canAddInstance) {\n                    config.events.onRequestSaveAs = onRequestSaveAs;\n                }\n\n                var usersToMention = data.userstomention;\n\n                var onRequestUsers = function() {\n                    docEditor.setUsers({'users': usersToMention});\n                };\n\n                if (usersToMention !== null) {\n                    config.events.onRequestUsers = onRequestUsers;\n                    config.events.onRequestSendNotify = onRequestSendNotify;\n                }\n\n                if ((config.document.fileType === \"pdf\")\n                    // eslint-disable-next-line no-undef\n                    && DocsAPI.DocEditor.version().split(\".\")[0] < 8) {\n                    displayNotification('oldversion', 'error');\n                } else {\n                    // eslint-disable-next-line no-undef\n                    docEditor = new DocsAPI.DocEditor(\"onlyofficeeditor-editor\", config);\n                }\n            });\n        }\n    };\n});\n"],"names":["define","$","displayNotification","error","type","require","notification","str","errorIsAvailable","get_string","when","done","localizedStr","addNotification","message","urlParam","name","results","RegExp","exec","window","location","href","decodeURI","replaceActionLink","linkParam","actionIndex","indexOf","substring","encodeURIComponent","data","init","courseid","cmid","DocsAPI","enterFullScreenText","exitFullScreenText","navLeftButton","navRightButton","editorContainer","localized","enterButton","document","createElement","enterIcon","className","appendChild","id","innerHTML","onclick","hide","getAttribute","click","length","checked","addClass","children","style","height","show","before","exitButton","exitIcon","removeClass","prepend","ajaxUrl","M","cfg","wwwroot","getJSON","actionType","actionData","docEditor","config","head","documentType","canAddInstance","addinstance","innerAlert","inEditor","console","log","showMessage","events","event","action","setActionLink","onRequestSaveAs","saveAsData","ModalSaveas","build","displaySaveAsModal","title","url","section","usersToMention","userstomention","onRequestUsers","setUsers","onRequestSendNotify","mentionData","comment","emails","link","actionLink","ajax","dataType","fail","fileType","DocEditor","version","split"],"mappings":"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"}
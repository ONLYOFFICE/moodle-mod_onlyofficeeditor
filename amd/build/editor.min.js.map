{"version":3,"file":"editor.min.js","sources":["../src/editor.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module mod_onlyofficeeditor/editor\n * @copyright  2024 Ascensio System SIA <integration@onlyoffice.com>\n * @copyright  based on work by 2018 Olumuyiwa Taiwo <muyi.taiwo@logicexpertise.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n **/\ndefine(['jquery'], function($) {\n    var displayNotification = function(error, type) {\n        require(['core/notification'], function(notification) {\n            require(['core/str'], function(str) {\n                var errorIsAvailable = str.get_string(error, 'onlyofficeeditor');\n                $.when(errorIsAvailable).done(function(localizedStr) {\n                    notification.addNotification({\n                        message: localizedStr,\n                        type: type\n                    });\n                });\n            });\n        });\n    };\n\n    var createFullScreenButtons = function() {\n        require(['core/str'], function(str) {\n            var enterFullScreenText = str.get_string('editorenterfullscreen', 'onlyofficeeditor');\n            var exitFullScreenText = str.get_string('editorexitfullscreen', 'onlyofficeeditor');\n            var navButton = $('nav .nav-link.btn')[0];\n            var editorContainer = $('.onlyofficeeditor-container')[0];\n\n            $.when(enterFullScreenText).done(function(localized) {\n                enterFullScreenText = localized;\n                var enterButton = document.createElement('button');\n                var enterIcon = document.createElement('i');\n                enterIcon.className = 'icon fa fa-expand fa-fw';\n                enterButton.appendChild(enterIcon);\n                enterButton.className = 'onlyofficeeditor-editor-fs-button';\n                enterButton.id = 'onlyofficeeditor-enter-fs-button';\n                enterButton.innerHTML += enterFullScreenText;\n\n                enterButton.onclick = function() {\n                    $('header').hide();\n                    $('footer').hide();\n                    if (navButton && navButton.getAttribute('aria-expanded') === 'true') {\n                        $('nav .nav-link.btn')[0].click();\n                    }\n                    editorContainer.style.cssText = 'position: absolute; left: 0; right: 0; top: 0; ' +\n                        'padding: 0 16px 0 16px; z-index: 100;';\n                    editorContainer.children[0].style.height = '93.5vh';\n                    $('#onlyofficeeditor-enter-fs-button').hide();\n                    $('#onlyofficeeditor-exit-fs-button').show();\n                };\n                editorContainer.before(enterButton);\n            });\n            $.when(exitFullScreenText).done(function(localized) {\n                exitFullScreenText = localized;\n                var exitButton = document.createElement('button');\n                var exitIcon = document.createElement('i');\n                exitIcon.className = 'icon fa fa-compress fa-fw';\n                exitButton.appendChild(exitIcon);\n                exitButton.innerHTML += exitFullScreenText;\n                exitButton.className = 'onlyofficeeditor-editor-fs-button';\n                exitButton.id = 'onlyofficeeditor-exit-fs-button';\n\n                exitButton.onclick = function() {\n                    editorContainer.style.cssText = '';\n                    editorContainer.children[0].style.height = '95vh';\n                    $('header').show();\n                    $('footer').show();\n                    $('#onlyofficeeditor-enter-fs-button').show();\n                    $('#onlyofficeeditor-exit-fs-button').hide();\n                };\n                $('.usernav .nav-item')[0].prepend(exitButton);\n                $('#onlyofficeeditor-exit-fs-button').hide();\n            });\n        });\n    };\n\n    $.urlParam = function(name) {\n        var results = new RegExp('[\\\\?&]' + name + '=([^&#]*)').exec(window.location.href);\n        if (results === null) {\n            return null;\n        }\n        return decodeURI(results[1]) || 0;\n    };\n\n    var replaceActionLink = function(href, linkParam) {\n        var link;\n        var actionIndex = href.indexOf(\"&actionType=\");\n        if (actionIndex != -1) {\n            link = href.substring(0, actionIndex) + \"&actionType=\" + encodeURIComponent(linkParam.type) +\n                \"&actionData=\" + encodeURIComponent(linkParam.data);\n        } else {\n            link = href + \"&actionType=\" + encodeURIComponent(linkParam.type) + \"&actionData=\" + encodeURIComponent(linkParam.data);\n        }\n        return link;\n    };\n\n    var saveAsModal = null;\n\n    var displaySaveAsModal = function(saveAsData, cmid, courseid) {\n        require(['jquery', 'core/templates', 'core/modal_factory', 'mod_onlyofficeeditor/modal_saveas'],\n            function($, Templates, ModalFactory, ModalSaveas) {\n                var trigger = $('.onlyofficeeditor-container');\n                if (saveAsModal === null) {\n                    saveAsModal = ModalFactory.create({\n                        type: ModalSaveas.TYPE\n                    }, trigger);\n                }\n                saveAsModal.done((modal) => {\n                    modal.courseid = courseid;\n                    modal.CMID = cmid;\n                    modal.saveAsData = saveAsData;\n                    modal.renderSections(modal.getBody(), cmid, courseid);\n                    modal.show();\n                });\n            });\n    };\n\n    return {\n        init: function(courseid, cmid) {\n            if (typeof DocsAPI === \"undefined\") {\n                displayNotification('docserverunreachable', 'error');\n                return;\n            }\n            createFullScreenButtons();\n            var ajaxUrl = M.cfg.wwwroot + '/mod/onlyofficeeditor/dsconfig.php';\n            $.getJSON(ajaxUrl, {\n                courseid: courseid,\n                cmid: cmid,\n                actionType: $.urlParam('actionType'),\n                actionData: $.urlParam('actionData')\n            }).done(function(data) {\n                var docEditor = null;\n                var config = data.config;\n\n                var favicon = config.documentType;\n                if (config.fileType === 'docxf' || config.fileType === 'oform') {\n                    favicon = config.fileType;\n                }\n                document.head.innerHTML += '<link type=\"image/x-icon\" rel=\"icon\" href=\"/mod/onlyofficeeditor/pix/'\n                    + favicon + '.ico\" />';\n\n                var canAddInstance = data.addinstance;\n\n                const innerAlert = (message, inEditor) => {\n                    // eslint-disable-next-line no-console\n                    if (console && console.log) {\n                        // eslint-disable-next-line no-console\n                        console.log(message);\n                    }\n                    if (inEditor && docEditor) {\n                        docEditor.showMessage(message);\n                    }\n                };\n\n                var onMakeActionLink = function(event) {\n                    var actionData = event.data.action;\n                    docEditor.setActionLink(replaceActionLink(location.href, actionData));\n                };\n\n                var onRequestSendNotify = function(event) {\n                    var comment = event.data.message;\n                    var emails = event.data.emails;\n                    var replacedActionLink = replaceActionLink(location.href, event.data.actionLink.action);\n\n                    var mentionData = {\n                        comment: comment,\n                        emails: emails,\n                        link: replacedActionLink,\n                        courseid: courseid\n                    };\n\n                    $.ajax(M.cfg.wwwroot + '/mod/onlyofficeeditor/onlyofficeeditorapi.php?apiType=mention&cmid=' + cmid, {\n                        type: 'POST',\n                        dataType: 'json',\n                        data: mentionData\n                    }).fail(() => {\n                        displayNotification('onmentionerror', 'error');\n                    });\n                };\n\n                const onAppReady = () => {\n                    innerAlert(\"Document editor ready\");\n                };\n\n                const onError = (event) => {\n                    if (event) {\n                        innerAlert(event.data);\n                    }\n                };\n                config.events = {\n                    'onAppReady': onAppReady,\n                    'onError': onError,\n                    'onMakeActionLink': onMakeActionLink\n                };\n\n                var onRequestSaveAs = function(event) {\n                    var saveAsData = {\n                        title: event.data.title,\n                        url: event.data.url,\n                        courseid: courseid,\n                        section: null\n                    };\n                    displaySaveAsModal(saveAsData, cmid, courseid);\n                };\n\n                if (canAddInstance) {\n                    config.events.onRequestSaveAs = onRequestSaveAs;\n                }\n\n                var usersToMention = data.userstomention;\n\n                var onRequestUsers = function() {\n                    docEditor.setUsers({'users': usersToMention});\n                };\n\n                if (usersToMention !== null) {\n                    config.events.onRequestUsers = onRequestUsers;\n                    config.events.onRequestSendNotify = onRequestSendNotify;\n                }\n\n                if ((config.document.fileType === \"docxf\" || config.document.fileType === \"oform\")\n                    // eslint-disable-next-line no-undef\n                    && DocsAPI.DocEditor.version().split(\".\")[0] < 7) {\n                    displayNotification('oldversion', 'error');\n                } else {\n                    // eslint-disable-next-line no-undef\n                    docEditor = new DocsAPI.DocEditor(\"onlyofficeeditor-editor\", config);\n                }\n            });\n        }\n    };\n});\n"],"names":["define","$","displayNotification","error","type","require","notification","str","errorIsAvailable","get_string","when","done","localizedStr","addNotification","message","urlParam","name","results","RegExp","exec","window","location","href","decodeURI","replaceActionLink","linkParam","actionIndex","indexOf","substring","encodeURIComponent","data","saveAsModal","init","courseid","cmid","DocsAPI","enterFullScreenText","exitFullScreenText","navButton","editorContainer","localized","enterButton","document","createElement","enterIcon","className","appendChild","id","innerHTML","onclick","hide","getAttribute","click","style","cssText","children","height","show","before","exitButton","exitIcon","prepend","ajaxUrl","M","cfg","wwwroot","getJSON","actionType","actionData","docEditor","config","favicon","documentType","fileType","head","canAddInstance","addinstance","innerAlert","inEditor","console","log","showMessage","events","event","action","setActionLink","onRequestSaveAs","saveAsData","Templates","ModalFactory","ModalSaveas","trigger","create","TYPE","modal","CMID","renderSections","getBody","displaySaveAsModal","title","url","section","usersToMention","userstomention","onRequestUsers","setUsers","onRequestSendNotify","mentionData","comment","emails","link","actionLink","ajax","dataType","fail","DocEditor","version","split"],"mappings":"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"}